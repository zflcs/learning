

![](../assets/polltrait.PNG)

**背景：** 目前做了一个共享调度器，提供给内核和用户进程协程运行时，但是是直接编译成二进制文件，链接到固定的地址，想编译成 so 格式的文件，解决这个固定地址的问题。

**困难：** 编译成 so 格式，只能编译成 cdylib（纯 rust 的 dylib 格式的用法产生很大变化，只能用于 cargo 中间编译），但这必须要保证 FFI 安全。尽管在暴露给内核和用户的接口能保证 FFI 安全，但它必须要求所有调用的函数都是 FFI 安全的，但最核心的 `poll` 函数本身不是 FFI 安全，问题的关键在此，必须得在编译器上做些修改才能支持。