
### FPGA 部署流程

目前已经能够在 WSL 上运行模拟器，看到串口得输出了。

#### 构建 vivado 项目
按照[标签化 RISC-V fpga部署指南](https://github.com/LvNA-system/labeled-RISC-V/blob/master/fpga/README.md#run-with-fpga)的提示进行操作，目前仓库里已经增加了 zcu102 的补丁。

因为 vivado 安装在 windows 上，之前曾经在 wsl 上启动过 windows 下的 vivado，所以按照这个思路修改环境变量试图直接在 wsl 中启动 windows 下的 vivado，没有成功。

所以还是按照提示来进行，先在 lrv 的 fpga 目录中执行一遍 `make -C pardcore BOARD=zcu102` 指令，生成 pardcore，再下载到 windows 上。



#### shell 响应慢
初步怀疑和内核目前的调度方式相关，内核的调度以协程的形式来完成，因此在切换回原来的形式（初始化之后运行调度函数，只有核 0 处理内核协程）之后，shell 的响应速度正常。

将内核的调度实现为协程之后，内核初始化完成之后，处于 idle 线程（没有显式的初始化创建线程操作）内，执行循环 poll 内核协程的函数（poll_kernel_future），与用户线程相同，但内核线程的状态转换与用户线程的状态转换存在区别。

##### 目前调度协程的实现
```rust
pub async fn run_tasks() {
    let mut helper = Box::new(ReadHelper::new());
    loop {
        if let Some(task) = fetch_task() {
            PROCESSORS[hart_id()].run_next(task);
            PROCESSORS[hart_id()].suspend_current();
        }
		helper.as_mut().await;
    }
}
```
无论能否从线程池取出协程，都会对 helper 进行 poll，这导致了大量的协程切换开销。假设在执行某个线程之后，它会向内核提交某些内核协程，这些协程的优先级比调度协程的优先级高，因此在发生时钟中断回到 idle 线程时，内核的调度协程需要让权。基于上述的假设，将 await 放在 if 语句内，减少协程切换开销。
```rust
pub async fn run_tasks() {
    let mut helper = Box::new(ReadHelper::new());
    loop {
        if let Some(task) = fetch_task() {
            PROCESSORS[hart_id()].run_next(task);
            PROCESSORS[hart_id()].suspend_current();
			helper.as_mut().await;
        }
    }
}
```

移动到 if 语句内，仍然不能即使响应，在将切换的频率降低之后，得到了正常响应。

#### 0x101000000 页错误

把 MEMORY_END 扩大之后，遇到了 0x101000000 页错误，还不清楚是什么原因。

所有用户进程也同时映射了 trace 阶段的地址，因此在将所有的 trace 代码注释之后，能够正常运行测试。

堆进行了扩展，目前应该可以运行相关的测试。

#### 创建进程时，查找符号表慢（暂时不考虑）



#### apmr（环个数+环长度+数据量+线程数）
##### 4 + 512 + 1 + 1
8371、8532、8344、8371、8415、8451、8402、8535、8435、8343
##### 4 + 512 + 1 + 2
5804、5875、5745、5776、5707、5894、5795、5692、5817、5900
##### 4 + 512 + 1 + 3
4263、4315、4305、4298、4323、4284、4334、4369、4300、4337
##### 4 + 512 + 1 + 4
4264、4197、4237、4278、4276、4290、4262、4237、4227、4246
##### 4 + 512 + 1 + 5
18871、19873、19902、14465、20403、19302、19302、20289、18357、18938

##### 4 + 512 + 228 + 1


#### ct（定时+矩阵大小+连接数）
##### 协程 50 + 1 + 1
时延：
24641、24123、22815、23777、24148、23420、24915、24341、24468、23600
吞吐量：
86、86、85、86、85、85、85、85、86、86

##### 协程 50 + 1 + 2
时延：
27106、28477、27910、28182、26943、28686、28969、27145、27686、27632
吞吐量：
170、169、170、170、171、170、169、172、170、170

##### 协程 50 + 1 + 4
时延：
33941、35039、34685、35043、36585、34572、34841、37163、34500、34715
吞吐量：
335、336、337、334、333、334、336、335、336、336

##### 协程 50 + 1 + 8
时延：
48249、46923、46902、47196、47112、45288、47291、48024、49785、46474
吞吐量：
640、649、642、636、641、637、646、643、644、642

##### 协程 50 + 1 + 16
时延：
38020、34548、33486、34508、37053、39828、38628、35657、34269、33891
吞吐量：
727、678、696、651、679、709、695、709、655、668

##### 协程 50 + 1 + 32
时延：

吞吐量：



#### ctt（定时+矩阵大小+连接数）
##### 线程 50 + 1 + 1
时延：
43223、40383、41263、39785、42088、41791、41902、44263、44261、45602
吞吐量：
83、83、83、84、84、83、83、83、83、83

##### 线程 50 + 1 + 2
时延：
59070、54927、65116、55354、65931、56760、61855、57679、57195、55164
吞吐量：
165、168、167、166、165、166、166、166、166、166

##### 线程 50 + 1 + 4
时延：
91222、91179、89252、91390、94406、93653、88385、86451、94174、100959
吞吐量：
327、324、330、330、326、327、326、328、325、329

##### 线程 50 + 1 + 8
时延：
153710、168245、173206、168756、165058、167181、132164、132670、160420、162358、161100、166144、172128、175943、192927、120246、158826、166450、140287、127561
吞吐量：
631、634、634、635、626、637、124、139、226、583、371、630、634、634、624、145、269、565、169、157

##### 线程 50 + 1 + 16
时延：
202245、278146、259410、340982、185576、247840、183636、371988、390729、141439、324150、202980、136073、45126、58382、376018、325891、360181、455107、201035
吞吐量：
190、735、449、456、264、220、231、1151、742、107、612、238、60、10、9、1180、501、522、866、207

##### 线程 50 + 1 + 32
时延：

吞吐量：


#### cwpt（定时+矩阵大小+服务器线程）
##### 100 + 40 + 2





























#### apmr
##### 4+128+3876：
2729、2564、2595、2507、2665、2745、2764、2693、2726、2592

#### connect_test
##### 协程 50 + 1 + 20：
28709、28713、28219、28250、28081、28679、29071、27778、29672、29625

##### 协程 50 + 2 + 20：
32835、33062、33291、31886、33922、32637、33675、32905、32388、32642

##### 协程 50 + 4 + 20：
43172、42818、46263、41324、41448、45223、42021、44713、42786、43299

##### 协程 50 + 8 + 20：
62008、64926、73583、51020、78256、52302、63805、68604、70165、59937

##### 协程 50 + 16 + 20：
38127、39866、38954、41001、40924、45048、40691、43185、42311、39012

##### 协程 50 + 32 + 20：
57698、59243、57664、58667、61436、85798、55573、55929、54140、61677

##### 协程 50 + 64 + 20：
120884、134359、112551、


#### connect_thread_test（定时+连接数+矩阵大小）
##### 线程 50 + 1 + 1

#### 串口输出问题，输出不了 total time
- 可能是代码存在的 bug，在 qemu 中体现不出来