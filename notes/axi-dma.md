### AXI-DMA 设计方案

#### Block Descriptor 以及 Block Descriptor Ring 内存问题

描述符的安全问题可以暂时先不考虑，按照目前 YYY 的设计在 DMA 初始化时，直接创建固定数量的描述符，直接 pin 住，不进行过多的设计。

这里可以通过 VecDeque 提供的操作完成对环形描述符的管理，而不是手动通过 head 和 tail 进行管理。



#### 缓冲区内存安全模型

只考虑单个缓冲区，不考虑设置多个缓冲区。

##### 提交缓冲区的原理

1. 根据 buf 的长度计算出需要多少个 BD，并且计算出 start 和 end BD 的位置，在 BD 对应的位置打上开始和结束标记；
2. 传输时，直接将 start BD 的描述符指针写到对应的寄存器，并启动对应的通道即可。



针对缓冲区的内存安全的优化：

目前 submit 缓冲区，使用的是缓冲区的引用，并没有获取缓冲区的所有权，被 pin 住的空间一直没有手动 drop，无法继续使用，从而导致内存泄漏。



在 submit 时，将缓冲区的所有权转移到submit 函数内，之后返回 Transfer 对象，里面包含缓冲区的所有权。目前的代码需要将 submit  和 to_hw 两个函数结合起来，才能够实现上述 Transfer 设计。

在 DMA 的数据结构初始化时，直接创建 pin 住的缓冲区，这个缓冲区重复使用，所有权一直由 DMA 的数据结合拥有，这种方式针对 rx 比较合理，因为接收时，必须先提交缓冲区才能产生中断，对于 tx 则不太符合逻辑，多一次内存复制操作。可以考虑申请缓冲区时，直接申请 DMA 缓冲区的区域。











