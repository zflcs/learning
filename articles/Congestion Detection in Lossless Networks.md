### Congestion Detection in Lossless Networks

#### Abstract

拥塞检测是端到端拥塞控制的基础。经过深入研究，发现主流无损网路的拥塞检测机制并不合适，不能够识别交换机中逐跳流量控制和拥塞检测行为之间的相互作用。因此，定义了交换机端口的三元状态，提出了主流无损网络的三元拥塞检测（TCD）。经过测试和模拟，TCD 可以准确的检测拥塞端口，并且可以识别出导致拥塞的流量以及仅受逐跳流量控制影响的流量。同时，对如何将 TCD 与速率控制相结合进行了探讨。实例研究表明，现有拥塞控制算法结合 TCD 可获得 3.3× 和 2.0× 更好的中位数和 99% FCT 下降。

#### Introduction

无损耗网络以其零丢包、低时延等优点成为集群系统发展的趋势。丢包会显著影响应用程序的尾延迟和吞吐量。此外 RDMA（远程直接内存访问）要求不丢包来达到最佳性能。目前两种主流的无损网络是 CEE（Converged Enhanced Ethernet）和 InfiniBand。

无损网络依靠逐跳流量控制来保证正常操作下的零丢包。InfiniBand 采用基于信用的流量控制（CBFC），融合以太网上的 RDMA 则是通过优先级流量控制（PFC）来实现，但是逐跳的流量控制会导致附带损失，包括线头阻塞、不公平甚至死锁。因此，端到端的拥塞控制是有必要的。

拥塞检测时端到端拥塞控制的基础，DCB（数据中心桥接）任务组和 InfiniBand 规范都规定了单个网络中的拥塞管理，但是都基于这样的框架，交换机来检测拥塞，端点来进行速率控制。经过深入的观察和分析，发现现有的无损网络拥塞检测机制不合适，不能识别出逐跳流量控制的影响。在无损网络中，交换机的端口在发送（ON）和暂停（OFF）之间交替。具体来说，ON - OFF 发送模式会对交换机的拥塞检测行为产生意想不到的影响，包括导致队列堆积和影响暂停端口的实际输入速率。

根据观察和理解，定义了交换机端口的三元状态，并提出了无损网络的三元拥塞检测(TCD)。三元状态为拥塞(1)、非拥塞(0)和待定(/)。处于拥塞状态的端口是拥塞发生的地方，而不是由 OFF 状态引起的队列堆积。详细讨论了三元状态之间的状态转换，特别是从待定状态到拥塞状态的转换，这是无损网络中拥塞检测的关键。

提出适用于主流无损网络的 TCD 统一设计，在低开销的交换机上实现。TCD可以将拥塞流（即通过拥塞端口的流）和未确定流（即仅通过未确定端口的流，即端口处于 ON-OFF 状态）通知到端点。

**主要贡献**：

- 深入理解逐跳流量控制对无损网络中的拥塞检测的影响，并定义三元状态。
- 提出了一种新的拥塞检测机制 TCD，该机制利用 ON - OFF 发送模式和队列长度演化的特点来检测三元状态之间的转变。实验台和大量的仿真表明，TCD可以准确地检测拥塞端口，并识别拥塞流量和未确定流量。
- 将 TCD 与现有的拥塞控制相结合。实例研究表明，现有的拥塞控制可以通过对拥塞流量进行积极的速率调整，而对不确定流量进行温和的速率调整来获得更好的性能。对现实工作负载的模拟表明，现有的拥塞控制结合 TCD 可以将 50% 和 99% 的 FCT 减速分别提高 3.3× 和 2.0×。

#### BACKGROUND

##### Congestion Detection Mechanisms in Lossless Networks

DCB 任务组规定了IEEE802.1 中的 QCN。在 QCN 中，CP通过抽样队列大小计算拥塞度量。由于 QCN 不支持 L3 网络，因此 DCQCN 在CEE 中得到了发展和广泛采用。与 QCN 类似，DCQCN 基于队列大小检测拥塞，CP 根据 RED 算法给数据包添加 ECN 标记，通过 ECN 位标记表示存在拥塞。

InifiBand 规范规定了 IB CC。交换机应该识别两种情况：1）如果输出端口的队列超过阈值，并且有可用的信用来发送数据包，那么它是根源；2）如果一个输出端口的队列超过了选定的阈值，数据包由于缺少信用而延迟，那么它就是受害者。一个交换机端口被认为是拥塞的，当它是拥塞的根源时，就用正向 ECN（FECN）位标记数据包。对于 CA，FECN 位标记表示存在拥塞。

综上所述，现有的 CEE 和 IB 拥塞检测机制基本上是根据队列大小来检测早期拥塞，这与传统的有损网络的做法相同。除了利用队列长度作为主要拥塞指标外，IB CC 还结合信用信息来检测拥塞。

##### Flow Controls for Lossless Networks

CEE 采用优先级流量控制（PFC）， InfiniBand 采用基于信用的流量控制（CBFC）。

在 PFC 中，当下游的交换机的输入队列超过了阈值 Xoff 时，会向上游的交换机发送 PAUSE 帧，当输入队列减少到另一个阈值 Xon 时，向上有交换机发送 RESUME 帧。上游的交换机只有在输出队列没有被暂停时才可以发送。

在 CBFC 中，下游交换机维护一个调整块寄存器（ABR）记录总共接收的快数目。此外，下游交换机周期性地向上游交换机发送流量控制信用限制（FCCL）消息，该消息包含分配的缓冲区大小和 ABR 的总和。上游交换机维护一个流量控制总发送块（FCTBS）寄存器，以记录总发送块数目。在收到 FCCL 消息后，可用信用的数量是 FCCL 和 FCTBS 之间的差值。然后，上游交换机只能在有可用信用时发送分组。

PFC 按优先级运行。CBFC 在每个虚拟线路（VL）级别上运行。CEE 交换机和 InfiniBand 交换机中的优先级队列和 VL 数量都受到限制。本质上，PFC 和 CBFC 以相同的方式运行以避免缓冲区溢出：交换机端口在发送（ON）和暂停（OFF）之间交替。如果端口暂停（OFF），则后续数据包将排队等待下游交换机的可用缓冲区空间。

#### OBSERV ATIONS AND INSIGHTS

#####  Experimental Observations

在 CEE 中，仅基于队列的拥塞检测基本上是不够的。交换机无法区分拥塞和PAUSE导致的队列堆积。因此，未拥塞的端口可能被错误地视为拥塞的端口。

在   InfiniBand中，CBFC的定期更新信用也会混淆拥塞检测。

逐跳流量控制的 ON-OFF 调节掩盖了实际输入速率。详细观察和分析表明，现有的拥塞检测机制无法识别 ON-OFF 发送模式的影响，导致无损网络（如 CEE 和 InfiniBand）中的拥塞检测结果不准确，端口可能具有相同的队列长度演变和发送模式，但实际拥塞状态是不同的。

##### Understanding Port States in Lossless Networks

- 无拥塞（0）：端口持续打开且没有队列堆积。
- 拥塞（1）：端口持续开启。输出速率为全速率，队列聚集不是由关闭引起的。
- 未确定（/）：输出速率为 ON-OFF 模式。

一旦端口收到 PAUSE/no credit，端口进入未确定状态。

拥塞检测的关键是捕获三元状态之间的状态转换。

#### TERNARY CONGESTION DETECTION

##### Congestion State Transitions

##### Conceptual ON-OFF Model





#### DISCUSSION

##### 设计权衡：

动态调整 Ton vs 预先静态配置 Ton：动态调整 Ton 增加了设计复杂度和开销并且只会带来边际效益；预先配置 Ton，如果异常传输的 Ton 远低于配置的 max Ton，它不会影响对转换到未确定状态的检测，只会导致在离开未确定状态时的有限延迟检测，如果异常传输的 Ton 高于 max Ton，未确定端口可以在未确定状态和非拥塞/拥塞状态之间以低频率切换。

##### 与拥塞控制合作：

积极降低拥塞流的速率并温和地调整未确定流的速率是我们在无损网络中与拥塞控制合作的 TCD 的一般建议。如果在无损网络中不触发PFC/CBFC，那么简单地对拥塞流量采取比现有拥塞控制更积极的减少可能会损害链路利用率和吞吐量。

#### 相关工作

现有的拥塞检测机制分为三类

- 交换机拥塞检测
- 交换机和端点协作拥塞检测
- 端到端拥塞检测

接收器驱动的拥塞控制

#### 总结

本文重新理解了无损网络中的拥塞检测，并提出了用于CEE和InfiniBand的三元拥塞检测（TCD）。我们揭示了一种新的端口状态，称为待定状态，并定义了三元状态。试验台和大量模拟表明，TCD可以准确地检测拥堵端口，识别拥堵流和未确定流。案例研究表明，现有的拥塞控制算法通过与TCD相结合可以获得更好的性能，证实了准确的拥塞检测对于拥塞控制具有重要意义。
