### DNS Cache Poisoning Attack: Resurrections with Side Channels

#### Abstract

DNS是Internet上支持许多网络应用程序和服务的基本和古老协议之一。不幸的是，DNS在设计时没有考虑到安全性，并且会受到各种严重攻击，其中之一就是众所周知的DNS缓存中毒攻击。经过几十年的发展，在其上加装强大的安全功能已被证明是极具挑战性的。

迄今为止，只有基于随机化原理的较弱版本的防御被广泛部署，例如UDP临时端口号的随机化，这使得非路径攻击者很难猜到秘密。然而，正如最近所显示的，这种随机性会受到巧妙的网络侧信道攻击，这可以有效地减少短暂端口号的随机性。

#### Introduce

DNS 将人可读的域名转化成机器可读的 IP，这个基本功能也被各种安全服务所使用，因此破环 DNS，会导致灾难性的安全故障。

从历史上看，效率是DNS的首要考虑因素，导致通过UDP设计单个查询和响应，这仍然是当今使用的主要机制。虽然DNSSEC和DNS cookie等安全功能已经标准化，但由于向后兼容，它们尚未广泛部署。这导致了一系列DNS缓存中毒攻击，这些攻击允许非路径攻击者使用恶意记录毒害DNS缓存，以将域映射到任意IP地址。

目前还不清楚网络栈中还有多少这样的侧信道。在本文中，我们探讨了一种非常规类型的端口扫描数据包，即ICMP数据包，它是设计错误消息，无法请求任何显式响应。这与SADDNS不同，SADDNS将UDP数据包视为常规端口扫描数据包。ICMP探测如何允许非路径攻击者推断为UDP套接字选择的临时端口号。

我们发现了潜伏在Linux网络栈中超过十年但以前不为人所知的新的侧信道。

在DNS环境中成功利用这些副通道取决于三个不同层（即ICMP、UDP和应用程序）之间的微妙交互。有趣的是，由于缺乏文档和意识，这种交互经常被忽视和误解，导致许多可利用的场景。

除了新颖的侧信道外，我们还发现ICMP消息可用于DoS DNS事务，间接协助缓存中毒攻击。

为了减轻攻击，建议设置适当的套接字选项，随机化缓存结构，并在可能的情况下拒绝特定的ICMP消息。

文章的工作：

- 发现了新的侧信道，允许我们使用ICMP探测扫描UDP临时端口。
- 彻底分析了发现的侧信道的根本原因，并在此基础上开发了强大的DNS缓存中毒攻击。
- 衡量了它们在现实世界中的影响，并提出了相应的缓解措施。

#### Background

##### Public-facing and Private-facing UDP Ports

传统的端口扫描指的是扫描服务器端口，目的是为了知道哪些服务正在运行。然而，在DNS缓存中毒攻击的情况下，目标是扫描临时端口。UDP临时端口与TCP不同，因为UDP的无状态性质，临时端口进一步被划分成两类：面向公共端口、面向私有端口。

具体来说，如果客户端通过调用 sendto() 以特定的远程IP作为参数来发送UDP数据包，那么客户端OS在随后调用 recvfrom() 时实际上会接受来自“任何IP”的数据包。因此，默认情况下，任何UDP临时端口都将面向公共。只有当客户端显式调用 connect() 时，OS 才会拒绝来自除一个“已连接”的远程IP之外的所有远程IP的数据包。这有效地使临时端口面向私人。

面向公共的临时端口通常更容易扫描。临时端口是否面向公共会对确定新的侧信道产生影响。

##### ICMP Messages and Impact on UDP

ICMP是一种诊断协议，用于在传送IP数据包期间发出错误信号。为了让发送方区分哪些数据包遇到了错误，ICMP消息中嵌入了数据包的部分副本，其中包括源和目标地址、源和目标端口。

近期的 RFC 指明，只有当包装的四元组与现有套接字匹配时，发送方才会接受此类消息。在验证此类ICMP消息的正确性后，根据错误的性质和应用程序设置的套接字选项，源程序可以忽略错误，通过在OS内核中采取操作或通过套接字接口向应用程序层报告错误来纠正这种情况。

与 UDP 相关的 ICMP 消息

- Fragment Needed：路由器给发送方发需要分片 ICMP 消息，在其中包含了期望的 MTU 长度
- Redirect：下一跳路由器发给发送方指明到达目的地的较短路线，发送方接收到消息之后会更新路由表，并将所有的到达目的地的数据包都通过新的网关发送。（ICMP 消息中包含新网关的消息）该消息只应由网关发送，因此，源的OS通常在接受重定向之前检查ICMP消息的源IP。
- Host/Port Unreachable：此类消息用于向发送方发出信号，表明原始数据包已发送到错误的主机或端口，因此无法传递。在接收到这个消息之后，只要基于ICMP消息中嵌入的四元组找到套接字，OS就必须通知应用程序。

#### THREAT MODEL AND WORKFLOW

DNS 缓存毒性攻击中的通用模型。

**Assumptions：**通常，攻击者需要两种主要能力才能够发起攻击。

- 能够从目标 DNS 服务器触发一个或多个查询。
- 能够发送带有欺骗 IP 地址的数据包。

**Workflow：**攻击者处于路径外，因此无法修改或者窃听解析程序和域名服务器之间的通信。攻击的第一步是将解析器转换为愿意接受域名服务器响应的状态。（通过向解析器发送查询即可实现）之后，攻击者试图伪造一个响应包，并将其发送回受害者解析器，以毒害缓存。（恶意响应必须满足一下几点才可以被现代 DNS 解析器接受：1）源 IP 必须是域名服务器，由于是攻击者在查询中控制着域名，因此可以很容易的提前查找到对应的域名服务器；2）响应中的16位目标端口号必须与解析器随机生成的临时端口匹配；3）DNS 负载中的16位事务 ID 必须与解析器随机选择的事务 ID 匹配）

如果具有所有匹配字段的恶意响应在名称服务器发送的合法响应之前到达，那么解析器将接受并缓存恶意结果。这可能是一个不可逾越的障碍，因为攻击者需要在一个小的时间窗口内有效地枚举所有可能的32位值（相当于约40亿值）。即使攻击者可以在许多查询上重复这些尝试，这仍然是一种基本上不可行的攻击。

攻击有 6 个步骤：

- 识别受害解析程序、要中毒的域及其名称服务器。
- 减慢名称服务器的速度，并阻止它们响应受害者解析器；给攻击者更多的时间。
- 开始触发解析程序上的查询。
- 使用新侧信道推断查询的临时端口
- 端口已知后，通过伪造名称服务器的IP，向受害者解析器注入65536个具有不同TxID的恶意响应。
- 检查缓存是否中毒。如果没有，请返回（3）

#### ICMP-BASED EPHEMERAL PORT SCANS

##### 现有的基于 UDP 的端口扫描方法

传统上，UDP探测用于确定UDP端口（在探测中指定为目标端口号）是打开还是关闭。根据RFC[4，48]，如果目标回复ICMP端口不可访问消息，则表明端口已关闭。这通常用于探测服务器端口。这也可用于探测面向公众的临时端口。很明显，ICMP响应的存在或不存在是UDP探测的明确反馈。

**SADDNS：**要扫描面向私有的临时端口，必须使用远程对等端的源IP地址发送UDP探测，迫使非路径攻击者找到执行扫描的间接方式。如果猜测的端口号（在欺骗的UDP探测中）恰好与正确的临时端口匹配，解析器将不会生成ICMP消息（否则会生成）。这会导致一个固定的极限计数器或计数器的减量。然后，攻击者可以通过尝试使用UDP探测从其真实/非欺骗IP获取ICMP响应来检查计数器是否已耗尽。从根本上讲，这是传统的基于UDP的扫描的变体，因为目标仍然是间接推断ICMP响应的存在或不存在。

##### 基于 ICMP 的端口扫描

ICMP消息嵌入了来自源的原始数据包的报头，包括源端口和目标端口信息。这为创建嵌入猜测端口号的 ICMP 消息提供了机会，该端口号用于匹配接收方端的特定套接字。

无论端口号是否正确猜测，接收器都不会提供任何响应，这使得基于ICMP的端口扫描看起来不可行。

*令人惊讶的是，我们发现攻击者不一定必须依赖ICMP探测的明确反馈。相反，即使ICMP探测的处理是完全静默的，只要有一些共享资源的状态受到影响，我们就可以找到方法（其他探测）来观察共享资源的更改状态。*

经过研究，ICMP 消息中只有两类对于端口扫描有效：ICMP fragment need、ICMP redirect。它们在 Linux 内核中的处理逻辑以及形成侧信道的相应共享资源。

##### Analysis of ICMP Error Processing Logic

当OS收到带有嵌入式UDP数据包的ICMPv4消息时，它将调用 udp4_lib_err(0 来处理错误。这里，首先用套接字表（udp4_lib_looku()）检查包装的UDP数据包中的四元组，以验证ICMP数据包的合法性，即它确实是由主机之前发送的数据包触发的。如果它通过了检查，ICMP错误将根据错误类型进行处理。此外，如果操作系统收到正确的套接字选项，则可以选择将ICMP错误发送给应用程序。

为了处理ICMP需要分片和重定向消息，分别调用了两个相应的内核函数：ipv4_sk_redirect() 和ipv4_sk-update_pmtu()。它们都将更新路由模块中维护的全局资源，称为下一跳异常（fnhe）缓存。异常缓存中存储各种状态，包括特定远程IP的非默认MTU（由ICMP需要分片消息更新），以及特定远程IP的非默认网关IP（由ICMP重定向消息更新）。这些异常缓存条目会影响所有未来发送到条目中远程IP的数据包的路由决策。这些条目会被缓存一段时间，除非由于条目总数的限制而被明确逐出。

操作系统不会检查ICMP需要分片消息的源IP地址。这是设计的，因为这样的消息可以由路径上的任何路由器生成。由于互联网的动态特性，受害者解析器无法轻易验证给定IP是否属于路径上的路由器。因此攻击者对ICMP需要分片消息的探测根本不需要欺骗源IP地址。

##### Public-Facing Port Number Inference

对于 ICMP 需要分片消息，攻击者直接发送即可，不需要伪装，该消息嵌入了一个UDP报头，其猜测的源端口和目标端口为53。它还应该包含源IP地址和目标IP地址，它们应该分别是解析器的IP和名称服务器的IP。一些流行的 DNS 会生成面向公共的临时端口。Linux（和其他操作系统）对此类面向公共的端口的处理更加自由，并接受ICMP消息中的任何内部目标IP地址，只要内部源地址与解析器的IP匹配，并且内部源端口与临时端口匹配。这实际上意味着，对于这种面向公共的端口，可以很容易地欺骗解析器来更新任何远程IP的MTU（即使解析器之前可能没有与它们交谈过）。

为了观察缓存中的变化，攻击者可以简单地发送PING或任何其他数据包（验证数据包），这些数据包将触发解析器的回复（验证回复），并观察响应是否会因MTU降低而碎片化。如果使用ICMP重定向进行探测，其结果是受害者解析程序变得无响应，因为到攻击者的流量现在将被重定向到重定向消息中设置的错误网关IP（可能是黑洞）。

##### Private-Facing Port Number Inference

大多数DNS软件（例如BIND）都会生成面向专用的临时端口，从而使以前的方法无效。实施攻击必须进行的第一个调整是将内部目标IP地址设置为名称服务器的IP。这是因为 udp4_lib_lookup() 将检查嵌入式UDP数据包的完整四元组，以查找先前“连接”到特定远程IP和端口的套接字。因此，异常缓存状态更改对于名称服务器也是“私有”的，攻击者无法直接观察到。但是，还有另外的方法可以间接观察到状态变化。

关键思想是利用全局异常缓存中有限的总槽数。默认情况下，Linux将这种全局异常缓存组织为2048桶哈希表，该哈希表使用目标IP地址作为密钥，并具有长度为5和6个插槽（分别用于IPv6和IPv4）的链接列表，以解决每个桶的冲突。当链接列表达到限制时，最旧的异常将始终被逐出并替换为新插入的异常。因此攻击者可以与名称服务器的IP创建哈希冲突，攻击者先找到5个ip，它们均和名称服务器的ip存放在相同的哈希冲突桶中，这样攻击者就可以控制一个至少一个ip，之后，攻击者使用ICMP消息探测源端口号，从而可以扫描临时端口。这种情况和面向公共的临时端口相同。

##### Finding IPs that Cause Hash Collisions

10000个IP将使2048个条目哈希表上任意IP的冲突率达到98%以上。暴力的碰撞非常低效，因此不直接找到冲突集，而是选择推断 keyed hash function 使用的 secret。（hash function 是公共的，secret 只有32位，并且开机后一直使用，因此破解后可以持续使用）。根据经验评估，只需要3500个IPv4地址就可以可靠地在某些桶上找到一个或多个冲突集。因此，租用了3500个WS EC2实例来获取3500个不同的随机公共IP。

##### High-Speed Scans

**Batch scan：**一次性探测多个端口，并检查其中是否有任何端口命中正确的端口范围。类似于二分搜索，不断减小范围。在批处理中命中正确的端口后，需要以某种方式重置异常缓存状态。需要额外的返回消息。

**Single packet scan：**单次扫描，会有对应的 ID，根据 ID 可以清楚的知道在哪一批探测之后，异常缓存发生了更新。

#### VULNERABLE POPULATION

##### Conditions of Successful Attacks

- 在处理ICMP错误之前，必须检查嵌入UDP数据包中的端口号
- 必须缓存MTU或下一跳信息。
- 不得忽略内核中的ICMP需要分片或ICMP重定向消息。
- 收到ICMP消息后，不得关闭或重新发送查询。

条件1和2构成内核侧信道的基础。是否满足条件3取决于内核和DNS应用程序。然而，ICMP重定向消息不受任何套接字选项的影响，始终在内核中处理。对于条件4，这是必要的，端口扫描假定了临时端口在检测成功后保持不变。

##### Open Resolvers

只关注利用ICMP需要分片消息的攻击。这是因为基于ICMP重定向的攻击甚至在端口扫描时都需要IP欺骗，而且我们担心进行如此大规模的IP欺骗实验会造成入侵。因此，对于基于重定向的攻击进行小规模的测量。

#### PRACTICAL CONCERNS

##### Small Attack Window

默认情况下，攻击窗口仅为解析器和名称服务器之间的往返时间（从几十到几百毫秒不等），迫使攻击在很短的时间内完成端口扫描和65536个伪DNS响应的注入（暴力强制TxID）。然而，这并不是一个根本的障碍，因为攻击者可以简单地重复多次攻击；只要其中一次尝试成功，缓存就会中毒。

为了增加攻击窗口，攻击者可以尝试使名称服务器静音，即阻止名称服务器响应解析器的查询。如果成功，解析器将继续增加等待时间。

ICMP消息之一ICMP重定向也可以用于名称服务器静音。其想法是将恶意ICMP重定向发送到受害解析程序或名称服务器，以将目的地为彼此的流量重新路由到黑洞。由于查询/响应在到达错误的下一跳后丢失，因此受害者解析器将保持临时端口打开以供响应，直到查询超时（可能是几秒[45]），因此会创建一个巨大的攻击窗口。

##### Multiple Name Servers & Backend Servers

**Multiple name servers：**多名称服务器通常被认为是对DNS缓存毒性攻击的防御，但是，这种防御对我们的攻击几乎没有影响。

- 名称服务器的IP不太可能共享相同的哈希桶，因此可以独立地利用侧信道而不受自身干扰。
- 对于具有面向公共端口的解析器，攻击者可以像只有一个名称服务器一样扫描端口，因为内核不会检查ICMP探测中包裹的目标IP地址。唯一的区别在于TxID暴力强制，攻击者将注入多组65536个假响应包，每组使用不同名称服务器的欺骗IP。由于通常配置的名称服务器数量较少，因此这种额外的数据包负载实际上不是一个基本障碍。

**Multiple backend servers：**大型DNS解析器往往在一个前端IP后面有多个后端服务器，后端服务器应该是实际的攻击目标。这些服务器更有可能被选中用于给定查询（目的地是名称服务器）。在这种情况下，攻击者只需要同时瞄准少量后端服务器，甚至是单个后端服务器，仍然能够获得相当的成功率。

##### Dual-Stack Resolvers

##### Noises

**Background traffic：**解析器处有两个潜在的后台流量源，可能会影响临时端口扫描。首先，受害者解析器可能同时有多个未完成的查询。在端口扫描期间，我们发现的临时端口可能属于不同的查询。面向私有的端口不是一个严重的问题，因为它们只对特定的名称服务器“可见”，

**Packet Losses：**如果包含正确临时端口的探测ICMP碰巧丢失，则可能会出现错误否定。

**Packet Reordering：**如果验证数据包在包含正确临时端口的ICMP探测之前意外到达，它将无法检测到异常缓存更改并导致错误否定。

#### EVALUATION

##### Resolver Attack

首先，整个攻击时间主要用于重复端口扫描（从最小端口到最大端口），占时间的96%到98%。剩余时间用于暴力强制TxID。第二，成功的时间取决于正确端口距离端口扫描开始的距离。在许多情况下，我们看到成功的时间只有几秒钟，而在更坏的情况下（尤其是当引入噪声时），可能需要30分钟才能找到端口并成功地强制发送TxID。

##### Other Attacks

#### DISCUSSION

##### Comparison with SADDNS

**Ephemeral port inference method：**第一个也是最重要的区别是在我们的攻击中使用ICMP探测。根据设计，ICMP消息被视为不应请求任何响应的错误[12]。这使得他们不太可能探索任何秘密。尽管如此，我们展示了对侧信道性质的卓越理解，使ICMP探测成为UDP临时端口扫描的成功入口。

**Side channel type：**我们的侧信道利用了空间资源限制（即，用于存储下一跳异常缓存的空间有限），而SADDNS的侧信道则利用了时间资源限制（例如，ICMP错误生成率有限）。此外，当处理传入的ICMP数据包时，我们的侧信道会出现（这就是为什么尽管没有发送ICMP探测数据包的回复，我们仍然可以推断出临时端口），而当处理传出的ICMP数据时，SADDNS的侧信道也会出现。

**Port scan speed：**由于分组接收路径中出现了新的空间约束侧信道，基于ICMP的临时端口扫描速率理论上可以是无限的。在实践中，攻击者还可以根据不同的网络条件灵活调整扫描速率和策略，以获得更高的成功率。然而，由于SADDNS使用的时间限制侧信道的性质，SADDNS仅允许固定的1000 pps慢速端口扫描。当与合法DNS响应竞争时，扫描速度慢直接导致成功率较低。

**Resistance to the noise：**与SADDNS中使用的全局计数器不同，SADDNS在所有远程IP之间共享，我们侧通道中使用的异常缓存是基于哈希的结构，仅与较小范围的IP共享，这降低了我们侧通道的噪声水平-它不太可能受到与随机IP相关的背景流量的干扰。此外，SADDNS需要强大的50ms时间块同步，这在有噪声的情况下很难实现。相比之下，我们的攻击没有如此严格的同步要求。

**Preparation of the attack：**与SADDNS相比，我们的攻击需要额外的步骤来推断哈希到同一桶中的冲突IP。尽管如此，对于我们目标的每个解析器来说，这只是一次性的努力。

##### PMTUD and DNS

##### Existing Defenses

除了可以抵御DNS缓存中毒攻击的临时端口随机化之外，已经有许多其他DNS安全解决方案。然而，由于各种原因，它们没有被广泛部署。

**DNSSEC：**将数据源身份验证和数据完整性添加到DNS。

**0x20 Encoding：**随机化域名（查询和响应）中字母的大小写，从而在TxID和临时端口之外引入额外的熵。

**DNS Cookie：**解析器和名称服务器之间 secret exchanged，旨在阻止任何形式的非路径响应注入。

##### New Defenses Against Our Attack

**设置正确的套接字选项：**最直接的方法是使用套接字选项 IP_PMTUDISC_OMIT，它指示操作系统不接受ICMP需要分片的消息，因此消除了内核中与侧信道相关的处理。

**随机化缓存结构：**与其他网络侧信道攻击的解决方案类似，充分随机化共享资源将使侧信道实际上不可用。

**拒绝ICMP重定向：**重定向最初设计用于具有多个网关的网络（类似于具有多个下一跳选项的路由器）。如果DNS服务器只有一个默认网关，则管理员应考虑忽略ICMP重定向消息以防止基于重定向的攻击，该攻击可以通过sysctl进行配置。

